name: RDP
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: windows-2025
    timeout-minutes: 3600
    steps:
      - name: Ownership Verification (Encoded)
        run: |
          $encodedNotice = "Cj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogQ29weXJpZ2h0IMKpIDIwMjUgVG9vbGJveExhcC54eXogfCBodHRwczovL3d3dy50b29sYm94bGFwLnh5ei8KIEFsbCByaWdodHMgcmVzZXJ2ZWQuIERvIG5vdCByZW1vdmUgb3IgbW9kaWZ5IGNvcHlyaWdodCB0ZXh0LgogWW91VHViZTogaHR0cHM6Ly93d3cueW91dHViZS5jb20vY2hhbm5lbC9VQ0RUNGZzOUp3cm5RSVhQclhYOHlIZVEKIEZhY2Vib29rOiBodHRwczovL3d3dy5mYWNlYm9vay5jb20vcHJvZmlsZS5waHA/aWQ9NjE1Njc4OTY2OTI5OTQKIEFueSBjaGFuZ2VzIHdpbGwgYXV0b21hdGljYWxseSBkaXNhYmxlIHRoaXMgc2NyaXB0IQo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0K"
          $decodedNotice = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($encodedNotice))
          Write-Host $decodedNotice
          if (-not $decodedNotice -or $decodedNotice -notlike "*ToolboxLap.xyz*") {
              Write-Error "Copyright was tampered with or removed â€“ script will not work!"
              exit 1
          }

      - name: Core RDP Settings
        run: |
          $folderPath = "D:\link subscribe youtube channel"
          if (-Not (Test-Path -Path $folderPath)) {
              New-Item -Path $folderPath -ItemType Directory
              Write-Host "Folder 'link subscribe youtube channel' has been created in D drive."
          } else {
              Write-Host "Folder 'link subscribe youtube channel' already exists in D drive."
          }

      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Create RDP User with Static Password
        run: |
          $password = "admin@123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          if (-not (Get-LocalUser -Name "TOOLBOXLAP" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "TOOLBOXLAP" -Password $securePass -AccountNeverExpires
          }
          Add-LocalGroupMember -Group "Administrators" -Member "TOOLBOXLAP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "TOOLBOXLAP"
          echo "RDP_CREDS=User: TOOLBOXLAP | Password: $password" >> $env:GITHUB_ENV
          if (-not (Get-LocalUser -Name "TOOLBOXLAP")) {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Install and Configure Rclone (Auto-Login)
        run: |
          # Install Rclone
          choco install rclone -y
          
          # Create Config Automatically for MEGA
          # Syntax: rclone config create [name] [type] [key=value]...
          # Note: We use the credentials provided by the user.
          $megaUser = "itmemugpig@otona.uk"
          $megaPass = "itmemugpig@otona.uk"
          
          Write-Host "Configuring Rclone for Mega..."
          
          # Define Portable Root & Ensure it exists
          $portableRoot = "D:\PortableSystem"
          if (-not (Test-Path $portableRoot)) { New-Item -Path $portableRoot -ItemType Directory -Force }
          
          # Create Config directly in the portable path
          rclone config create remote mega user $megaUser pass $megaPass --non-interactive --config "$portableRoot\rclone.conf"
          
          # Verify functionality
          if (rclone listremotes --config "$portableRoot\rclone.conf" | Select-String "remote:") {
              Write-Host "Mega Connected Successfully!"
          } else {
              Write-Error "Failed to connect to Mega."
              exit 1
          }

      - name: Restore & Configure Portable System
        run: |
          $portableRoot = "D:\PortableSystem"
          $userDirs = @("Desktop", "Documents", "Downloads", "Music", "Pictures", "Videos")
          
          # 1. Restore from Cloud (Safely)
          # CRITICAL: Use the specific config file path we created earlier
          if (rclone listremotes --config "$portableRoot\rclone.conf" | Select-String "remote:") {
              Write-Host "Checking for existing backup..."
              $backupExists = $false
              try {
                  rclone lsd remote:FullSystem --config "$portableRoot\rclone.conf" 2>&1 | Out-Null
                  if ($LASTEXITCODE -eq 0) { $backupExists = $true }
              } catch { $backupExists = $false }

              if ($backupExists) {
                 Write-Host "Restoring Portable System from Cloud..."
                 rclone copy remote:FullSystem $portableRoot --transfers=8 --checkers=16 --drive-chunk-size=64M -v --config "$portableRoot\rclone.conf"
              } else {
                 Write-Warning "No existing backup found (First Run). Skipping restore."
              }
          }

          # 2. Initialize Directory Structure (Ensure subdirs exist)
          # We run this unconditionally because the root might exist from Config step or Rclone restore
          foreach ($dir in $userDirs) {
              if (-not (Test-Path "$portableRoot\$dir")) {
                  New-Item -Path "$portableRoot\$dir" -ItemType Directory -Force
              }
          }
          
          # Update Cloud Folder
          Write-Host "Ensuring remote folder structure..."
          try { rclone mkdir remote:FullSystem --config "$portableRoot\rclone.conf" 2>&1 | Out-Null } catch {}
          
          # Create 'Upload To Cloud' (Sync Local -> Remote)
          $uploadScript = @"
          @echo off
          echo Uploading to Cloud (Sync D: -> Mega)...
          echo WARNING: This will DELETE files on Cloud that are not on this PC.
          C:\ProgramData\chocolatey\bin\rclone.exe sync D:\PortableSystem remote:FullSystem --transfers=8 --checkers=16 -v --config "D:\PortableSystem\rclone.conf" --exclude "rclone.conf*" --exclude "*.bat"
          echo Done!
          pause
          "@
          Set-Content -Path "$portableRoot\Desktop\Upload-To-Cloud.bat" -Value $uploadScript

          # Create 'Download From Cloud' (Copy Remote -> Local)
          $downloadScript = @"
          @echo off
          echo Downloading from Cloud (Copy Mega -> D:)...
          echo This will add/overwrite files from Cloud to this PC.
          C:\ProgramData\chocolatey\bin\rclone.exe copy remote:FullSystem D:\PortableSystem --transfers=8 --checkers=16 -v --config "D:\PortableSystem\rclone.conf" --exclude "rclone.conf*"
          echo Done!
          pause
          "@
          Set-Content -Path "$portableRoot\Desktop\Download-From-Cloud.bat" -Value $downloadScript

          # 3. Create Login Script (Run for User on Login)
          # We do this because NTUSER.DAT doesn't exist until first login.
          $loginScriptPath = "C:\Redirect-Profile.ps1"
          $scriptContent = @"
          `$portableRoot = '$portableRoot'
          `$regPath = 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders'
          `$map = @{
              'Desktop' = "`$portableRoot\Desktop";
              'Personal' = "`$portableRoot\Documents";
              '{374DE290-123F-4565-9164-39C4925E467B}' = "`$portableRoot\Downloads";
              'My Music' = "`$portableRoot\Music";
              'My Pictures' = "`$portableRoot\Pictures";
              'My Video' = "`$portableRoot\Videos"
          }
          foreach (`$key in `$map.Keys) {
              Set-ItemProperty -Path `$regPath -Name `$key -Value `$map[`$key] -Type ExpandString -Force
          }
          # Restart Explorer to apply immediately
          Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue
          "@
          Set-Content -Path $loginScriptPath -Value $scriptContent

          # 4. Register Script to Run on Login via HKLM
          $runKey = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
          Set-ItemProperty -Path $runKey -Name "RDP_Persistence_Init" -Value "powershell.exe -WindowStyle Hidden -ExecutionPolicy Bypass -File $loginScriptPath"
          
          Write-Host "Login script registered. Folders will redirect upon user login."
          
          # Force clean exit to prevent 'First Run' error code from failing the step
          exit 0





      - name: Establish Tailscale Connection (Interactive Link)
        run: |
          Write-Host "Starting Tailscale..."
          Write-Host "ðŸ‘‰ PLEASE CHECK THE LOGS BELOW FOR THE AUTHENTICATION LINK ðŸ‘ˆ"
          Write-Host "Copy the link and paste it in your browser to approve the device."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --hostname=gh-runner-$env:GITHUB_RUN_ID
          
          $tsIP = $null
          $retries = 0

          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Verify RDP Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Maintain Connection
        run: |
          $ownershipNotice = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("Cj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogQ29weXJpZ2h0IMKpIDIwMjUgVG9vbGJveExhcC54eXogfCBodHRwczovL3d3dy50b29sYm94bGFwLnh5ei8KIEFsbCByaWdodHMgcmVzZXJ2ZWQuIERvIG5vdCByZW1vdmUgb3IgbW9kaWZ5IGNvcHlyaWdodCB0ZXh0LgogWW91VHViZTogaHR0cHM6Ly93d3cueW91dHViZS5jb20vY2hhbm5lbC9VQ0RUNGZzOUp3cm5RSVhQclhYOHlIZVEKIEZhY2Vib29rOiBodHRwczovL3d3dy5mYWNlYm9vay5jb20vcHJvZmlsZS5waHA/aWQ9NjE1Njc4OTY2OTI5OTQKIEFueSBjaGFuZ2VzIHdpbGwgYXV0b21hdGljYWxseSBkaXNhYmxlIHRoaXMgc2NyaXB0IQo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0K"))
          Write-Host $ownershipNotice
          Write-Host "`n=== RDP ACCESS ==="
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: TOOLBOXLAP"
          Write-Host "Password: admin@123"
          Write-Host "Powered by https://www.toolboxlap.xyz/"
          Write-Host "========= All rights reserved =========`n"
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
              Start-Sleep -Seconds 300
          }