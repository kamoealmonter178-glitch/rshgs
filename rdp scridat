name: RDP
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: windows-2025
    timeout-minutes: 3600
    steps:
      - name: Ownership Verification (Encoded)
        run: |
          $encodedNotice = "Cj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogQ29weXJpZ2h0IMKpIDIwMjUgVG9vbGJveExhcC54eXogfCBodHRwczovL3d3dy50b29sYm94bGFwLnh5ei8KIEFsbCByaWdodHMgcmVzZXJ2ZWQuIERvIG5vdCByZW1vdmUgb3IgbW9kaWZ5IGNvcHlyaWdodCB0ZXh0LgogWW91VHViZTogaHR0cHM6Ly93d3cueW91dHViZS5jb20vY2hhbm5lbC9VQ0RUNGZzOUp3cm5RSVhQclhYOHlIZVEKIEZhY2Vib29rOiBodHRwczovL3d3dy5mYWNlYm9vay5jb20vcHJvZmlsZS5waHA/aWQ9NjE1Njc4OTY2OTI5OTQKIEFueSBjaGFuZ2VzIHdpbGwgYXV0b21hdGljYWxseSBkaXNhYmxlIHRoaXMgc2NyaXB0IQo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0K"
          $decodedNotice = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($encodedNotice))
          Write-Host $decodedNotice
          if (-not $decodedNotice -or $decodedNotice -notlike "*ToolboxLap.xyz*") {
              Write-Error "Copyright was tampered with or removed â€“ script will not work!"
              exit 1
          }

      - name: Core RDP Settings
        run: |
          $folderPath = "D:\link subscribe youtube channel"
          if (-Not (Test-Path -Path $folderPath)) {
              New-Item -Path $folderPath -ItemType Directory
              Write-Host "Folder 'link subscribe youtube channel' has been created in D drive."
          } else {
              Write-Host "Folder 'link subscribe youtube channel' already exists in D drive."
          }

      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Create RDP User with Static Password
        run: |
          $password = "admin@123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          if (-not (Get-LocalUser -Name "TOOLBOXLAP" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "TOOLBOXLAP" -Password $securePass -AccountNeverExpires
          }
          Add-LocalGroupMember -Group "Administrators" -Member "TOOLBOXLAP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "TOOLBOXLAP"
          echo "RDP_CREDS=User: TOOLBOXLAP | Password: $password" >> $env:GITHUB_ENV

          # Create Redirection Script (Pre-Login)
          $scriptContent = @"
          `$portableRoot = 'D:\PortableSystem'
          `$regPath = 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders'
          `$map = @{
              'Desktop' = "`$portableRoot\Desktop";
              'Personal' = "`$portableRoot\Documents";
              '{374DE290-123F-4565-9164-39C4925E467B}' = "`$portableRoot\Downloads";
              'My Music' = "`$portableRoot\Music";
              'My Pictures' = "`$portableRoot\Pictures";
              'My Video' = "`$portableRoot\Videos"
          }
          if (-not (Test-Path `$regPath)) { New-Item -Path `$regPath -Force }
          foreach (`$key in `$map.Keys) {
              Set-ItemProperty -Path `$regPath -Name `$key -Value `$map[`$key] -Type ExpandString -Force
          }
          
          # Performance Tweaks: Optimize for Speed over Quality
          `$desktop = 'HKCU:\Control Panel\Desktop'
          if (-not (Test-Path `$desktop)) { New-Item -Path `$desktop -Force }
          # 1. Disable Wallpaper & Theming
          Set-ItemProperty -Path `$desktop -Name "Wallpaper" -Value "" -Force
          Set-ItemProperty -Path `$desktop -Name "VisualizeVisualStyles" -Value 0 -Force
          # 2. Disable Font Smoothing (ClearType)
          Set-ItemProperty -Path `$desktop -Name "FontSmoothing" -Value "0" -Force
          # 3. Disable Full Window Dragging
          Set-ItemProperty -Path `$desktop -Name "DragFullWindows" -Value "0" -Force
          "@
          Set-Content -Path "C:\Redirect-Profile.ps1" -Value $scriptContent

      - name: Pre-load User Profile (Skip First Login Wait)
        run: |
          Write-Host "Pre-loading Windows User Profile for TOOLBOXLAP..."
          $password = ConvertTo-SecureString "admin@123" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ("TOOLBOXLAP", $password)
          
          # Run the redirection script AS THE USER to set HKCU keys immediately
          try {
              Start-Process powershell.exe -Credential $cred -ArgumentList "-ExecutionPolicy Bypass -File C:\Redirect-Profile.ps1" -LoadUserProfile -Wait
              Write-Host "Profile created and redirected successfully!"
          } catch {
              Write-Warning "Profile pre-load/redirection minor issue."
          }

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Install and Configure Rclone (Auto-Login)
        run: |
          # Install Rclone
          choco install rclone -y
          
          # Create Config Automatically for MEGA
          # Syntax: rclone config create [name] [type] [key=value]...
          # Note: We use the credentials provided by the user.
          $portableRoot = "D:\PortableSystem"
          if (-not (Test-Path $portableRoot)) { New-Item -Path $portableRoot -ItemType Directory -Force }

          # --- MEGALIST START ---
          # Add your accounts here. Format: "email : password"
          $megaAccounts = @(
              "itmemugpig@otona.uk : itmemugpig@otona.uk",
              "b67ebe3c01@webxio.pro : b67ebe3c01@webxio.pro",
              "d4d8692a49@webxio.pro : d4d8692a49@webxio.pro"
          )
          # --- MEGALIST END ---

          Write-Host "Configuring MegaHub (Multi-Account Pool)..."
          # Kill any existing Rclone processes to unlock rclone.conf
          Stop-Process -Name "rclone" -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 1
          
          $upstreams = @()
          $i = 1

          foreach ($account in $megaAccounts) {
              if ($account -match "(.+)\s*:\s*(.+)") {
                  $u = $matches[1].Trim()
                  $p = $matches[2].Trim()
                  $remoteName = "mega$i"
                  
                  Write-Host "Adding Account ${i}: $u"
                  rclone config create $remoteName mega user $u pass $p --non-interactive --config "$portableRoot\rclone.conf"
                  
                  if ($LASTEXITCODE -eq 0) {
                      $upstreams += "${remoteName}:FullSystem"
                      $i++
                      Start-Sleep -Milliseconds 500 # Prevent file locking
                  } else {
                      Write-Warning "Failed to add account: $u"
                  }
              }
          }

          if ($upstreams.Count -gt 0) {
              # Create Union Remote (The Pool)
              $upstreamString = $upstreams -join " "
              Write-Host "Creating Pool with upstreams: $upstreamString"
              
              Write-Host "Creating Pool with upstreams: $upstreamString"
              
              # Policy: lfs = Least Free Space (Fills gaps intelligently)
              # "Calculator Logic": Picks drive with least free space > chunk size.
              rclone config create pool union upstreams "$upstreamString" action_policy epall create_policy lfs search_policy ff --non-interactive --config "$portableRoot\rclone.conf"
              
              Start-Sleep -Seconds 2 # Give time for file release

              # Layer 3: The Liquidizer (Chunker) -> "The Calculator Logic"
              # Wrapping in retry loop to guarantee creation
              $sRetries = 0
              $sCreated = $false
              do {
                  Write-Host "Creating Splitter (Attempt $($sRetries+1))..."
                  rclone config create splitter chunker remote pool: chunk_size 256M hash_type md5 --non-interactive --config "$portableRoot\rclone.conf" 2>&1 | Out-Null
                  if (rclone listremotes --config "$portableRoot\rclone.conf" | Select-String "splitter:") { 
                      $sCreated = $true 
                  } else {
                      Start-Sleep -Seconds 2
                      $sRetries++
                  }
              } until ($sCreated -or $sRetries -ge 3)

              if ($sCreated) {
                  Write-Host "âœ… Smart Calculator Logic (MegaHub) Deployed Successfully!"
              } else {
                  Write-Error "Failed to initiate Calculator Logic (Splitter)."
                  exit 1
              }
          } else {
              Write-Error "No valid Mega accounts configured!"
              exit 1
          }

      - name: Restore & Configure Portable System
        run: |
          $portableRoot = "D:\PortableSystem"
          $userDirs = @("Desktop", "Documents", "Downloads", "Music", "Pictures", "Videos")
          
          # 1. Restore from Cloud (Safely)
          # CRITICAL: Use the specific config file path we created earlier
          if (rclone listremotes --config "$portableRoot\rclone.conf" | Select-String "splitter:") {
              Write-Host "Checking for existing backup..."
              $backupExists = $false
              try {
                  rclone lsd splitter: --config "$portableRoot\rclone.conf" 2>&1 | Out-Null
                  if ($LASTEXITCODE -eq 0) { $backupExists = $true }
              } catch { $backupExists = $false }

              if ($backupExists) {
                 Write-Host "Restoring Portable System from Cloud Pool..."
                 rclone copy splitter: $portableRoot --transfers=16 --checkers=32 --drive-chunk-size=64M -v --config "$portableRoot\rclone.conf"
              } else {
                 Write-Warning "No existing backup found (First Run). Skipping restore."
              }
          }

          # 2. Initialize Directory Structure (Ensure subdirs exist)
          # We run this unconditionally because the root might exist from Config step or Rclone restore
          foreach ($dir in $userDirs) {
              if (-not (Test-Path "$portableRoot\$dir")) {
                  New-Item -Path "$portableRoot\$dir" -ItemType Directory -Force
              }
          }
          
          # Update Cloud Folder
          Write-Host "Ensuring remote folder structure..."
          try { rclone mkdir splitter: --config "$portableRoot\rclone.conf" 2>&1 | Out-Null } catch {}
          
          # Create 'Upload To Cloud' (Sync Local -> Remote)
          $uploadScript = @"
          @echo off
          
          :: ------------------
          :: 1. Force Admin (Self-Elevation)
          :: ------------------
          fltmc >nul 2>&1 || (
              echo Requesting Admin Privileges...
              PowerShell -Command "Start-Process '%~f0' -Verb RunAs"
              exit /b
          )

          echo ---------------------------------------------------
          echo Current Mode: Smart Calculator Logic (LFS + Chunker)
          echo Strategy: Fill tightest gaps first, spill over rest.
          echo ---------------------------------------------------
          
          :: ------------------
          :: 2. Deep Self-Healing (Full Stack Rebuild)
          :: ------------------
          echo [Check] Verifying Integrity (Accounts + Logic)...
          C:\ProgramData\chocolatey\bin\rclone.exe listremotes --config "D:\PortableSystem\rclone.conf" | findstr "mega1" >nul
          if %errorlevel% neq 0 (
             echo [Fix] Critical: Base Accounts missing! Rebuilding ENTIRE MegaHub System...
             
             :: Re-create Accounts
             C:\ProgramData\chocolatey\bin\rclone.exe config create mega1 mega user itmemugpig@otona.uk pass itmemugpig@otona.uk --non-interactive --config "D:\PortableSystem\rclone.conf" >nul 2>&1
             C:\ProgramData\chocolatey\bin\rclone.exe config create mega2 mega user b67ebe3c01@webxio.pro pass b67ebe3c01@webxio.pro --non-interactive --config "D:\PortableSystem\rclone.conf" >nul 2>&1
             C:\ProgramData\chocolatey\bin\rclone.exe config create mega3 mega user d4d8692a49@webxio.pro pass d4d8692a49@webxio.pro --non-interactive --config "D:\PortableSystem\rclone.conf" >nul 2>&1
             
             :: Re-create Logic
             C:\ProgramData\chocolatey\bin\rclone.exe config create pool union upstreams "mega1:FullSystem mega2:FullSystem mega3:FullSystem" action_policy epall create_policy lfs search_policy ff --non-interactive --config "D:\PortableSystem\rclone.conf" >nul 2>&1
             C:\ProgramData\chocolatey\bin\rclone.exe config create splitter chunker remote pool: chunk_size 256M hash_type md5 --non-interactive --config "D:\PortableSystem\rclone.conf" >nul 2>&1
             
             echo [Fix] System Rebuilt Successfully.
          )
          echo.
          echo [Warm Up] Initializing Remotes Sequentially to prevent Locking...
          taskkill /F /IM rclone.exe /T >nul 2>&1
          C:\ProgramData\chocolatey\bin\rclone.exe about mega1: --config "D:\PortableSystem\rclone.conf" >nul 2>&1
          C:\ProgramData\chocolatey\bin\rclone.exe about mega2: --config "D:\PortableSystem\rclone.conf" >nul 2>&1
          C:\ProgramData\chocolatey\bin\rclone.exe about mega3: --config "D:\PortableSystem\rclone.conf" >nul 2>&1
          echo [Warm Up] Done. Starting Sync...
          echo [Warm Up] Done. Starting Sync...
          
          echo [Preparation] Closing Chrome to release database locks...
          taskkill /F /IM chrome.exe /T >nul 2>&1
          
          :: ==========================================
          :: GENERATE EXCLUSION LIST (User Defined)
          :: ==========================================
          (
           echo - /7-Zip/**
           echo - /Amazon/**
           echo - /Android/**
           echo - /Application Verifier/**
           echo - /Azure Cosmos DB Emulator/**
           echo - /CMake/**
           echo - /Common Files/**
           echo - /dotnet/**
           echo - /Git/**
           echo - /GitHub CLI/**
           echo - /Google/**
           echo - /Hyper-V/**
           echo - /IIS/**
           echo - /IIS Express/**
           echo - /ImageMagick*/**
           echo - /Internet Explorer/**
           echo - /LLVM/**
           echo - /Microsoft/**
           echo - /Microsoft*/**
           echo - /ModifiableWindowsApps/**
           echo - /MongoDB/**
           echo - /mongosh/**
           echo - /Mozilla Firefox/**
           echo - /MSBuild/**
           echo - /MySQL/**
           echo - /nodejs/**
           echo - /OpenSSL/**
           echo - /PackageManagement/**
           echo - /PostgreSQL/**
           echo - /PowerShell/**
           echo - /R/**
           echo - /Reference Assemblies/**
           echo - /Tailscale/**
           echo - /Unity Hub/**
           echo - /VS2010Schemas/**
           echo - /VS2012Schemas/**
           echo - /Windows Defender/**
           echo - /Windows Defender*/**
           echo - /Windows Mail/**
           echo - /Windows Media Player/**
           echo - /Windows NT/**
           echo - /Windows Photo Viewer/**
           echo - /WindowsPowerShell/**
           echo - /HTML Help Workshop/**
           echo - /Inno Setup 6/**
           echo - /Nuget/**
           echo - /Open XML SDK/**
           echo - /pipx/**
           echo - /pipx_bin/**
           echo - /sbt/**
           echo - /Visual Studio/**
           echo - /Windows Application Driver/**
           echo - /Windows Kits/**
           echo - /WiX Toolset v3.14/**
           echo - /chocolatey/**
           echo - /ChocolateyHttpCache/**
           echo - /dbg/**
           echo - /dftmp/**
           echo - /docker/**
           echo - /GitHub/**
           echo - /kind/**
           echo - /m2/**
           echo - /Microsoft DevDiv/**
           echo - /Microsoft Service Fabric/**
           echo - /Mozilla*/**
           echo - /Package Cache/**
           echo - /Packages/**
           echo - /regid*/**
           echo - /runner/**
           echo - /shimgen/**
           echo - /SoftwareDistribution/**
           echo - /ssh/**
           echo - /USOPrivate/**
           echo - /USOShared/**
           echo - /Windows App Certification Kit/**
           echo - /gemrc
           echo - /Temp/**
           echo - /Windows/**
          ) > "D:\PortableSystem\excludes.txt"
          
          echo.
          echo ===================================================
          echo PHASE 1: Registry Backup (Settings and Keys)
          echo ===================================================
          if not exist "D:\PortableSystem\Registry" mkdir "D:\PortableSystem\Registry"
          echo [Exporting] HKCU (User Settings)...
          reg export HKCU "D:\PortableSystem\Registry\HKCU.reg" /y >nul 2>&1
          echo [Exporting] HKLM\Software (Program Keys)...
          reg export "HKLM\SOFTWARE" "D:\PortableSystem\Registry\HKLM_Software.reg" /y >nul 2>&1
          
          echo.
          echo ===================================================
          echo PHASE 2: User Profile (Desktop, Docs, AppData...)
          echo ===================================================
          echo WARNING: This will DELETE files on Cloud that are not on this PC.
          C:\ProgramData\chocolatey\bin\rclone.exe sync D:\PortableSystem splitter: --transfers=16 --checkers=32 -P --config "D:\PortableSystem\rclone.conf" --exclude "rclone.conf*" --exclude "*.bat" --no-update-modtime
          
          echo.
          echo ===================================================
          echo PHASE 3: System Programs (Program Files and Data)
          echo ===================================================
          echo Excluding folders listed in D:\PortableSystem\excludes.txt...

          echo [Syncing] ProgramData...
          C:\ProgramData\chocolatey\bin\rclone.exe sync C:\ProgramData splitter:Backup/ProgramData --transfers=16 --checkers=32 -P --config "D:\PortableSystem\rclone.conf" --filter-from "D:\PortableSystem\excludes.txt" --no-update-modtime --ignore-errors
          
          echo [Syncing] Program Files...
          C:\ProgramData\chocolatey\bin\rclone.exe sync "C:\Program Files" "splitter:Backup/Program Files" --transfers=16 --checkers=32 -P --config "D:\PortableSystem\rclone.conf" --filter-from "D:\PortableSystem\excludes.txt" --no-update-modtime --ignore-errors
          
          echo [Syncing] Program Files (x86)...
          C:\ProgramData\chocolatey\bin\rclone.exe sync "C:\Program Files (x86)" "splitter:Backup/Program Files (x86)" --transfers=16 --checkers=32 -P --config "D:\PortableSystem\rclone.conf" --filter-from "D:\PortableSystem\excludes.txt" --no-update-modtime --ignore-errors

          echo.
          echo ===================================================
          echo PHASE 4: Google Chrome Data (Bookmarks/History)
          echo ===================================================
          echo [Syncing] Chrome User Data...
          C:\ProgramData\chocolatey\bin\rclone.exe sync "%LOCALAPPDATA%\Google\Chrome\User Data" splitter:Backup/ChromeData --transfers=16 --checkers=32 -P --config "D:\PortableSystem\rclone.conf" --no-update-modtime --ignore-errors
          
          echo.
          echo âœ… Full System Backup Complete!
          pause
          "@
          Set-Content -Path "$portableRoot\Desktop\Upload-To-Cloud.bat" -Value $uploadScript
          
          # Schedule Auto-Backup (Zero Resource Usage)
          # Trigger: EXACTLY 5 Hours from NOW (Server Start).
          # This protects against the 6-hour GitHub Actions timeout.
          try {
              $action = New-ScheduledTaskAction -Execute "$portableRoot\Desktop\Upload-To-Cloud.bat"
              $triggerTime = (Get-Date).AddHours(5)
              $trigger = New-ScheduledTaskTrigger -Once -At $triggerTime
              $principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
              $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable
              Register-ScheduledTask -Action $action -Trigger $trigger -Principal $principal -Settings $settings -TaskName "MegaHubAutoBackup" -Description "Auto Sync to Cloud at T+5h" -Force
              Write-Host "Auto-Backup Scheduled for $triggerTime (Server Shutdown Protection)."
          } catch {
              Write-Warning "Could not schedule Auto-Backup task."
          }

          # Create 'Download From Cloud' (Copy Remote -> Local)
          $downloadScript = @"
          @echo off
          echo Downloading from Cloud Pool (Copy MegaHub to D:)...
          echo This will add/overwrite files from Cloud to this PC.
          
          echo.
          echo [Restore] User Profile...
          C:\ProgramData\chocolatey\bin\rclone.exe copy splitter: D:\PortableSystem --transfers=16 --checkers=32 -v --config "D:\PortableSystem\rclone.conf" --exclude "rclone.conf*" --no-update-modtime
          
          echo.
          echo [Restore] System Programs...
          C:\ProgramData\chocolatey\bin\rclone.exe copy splitter:Backup/ProgramData C:\ProgramData --transfers=16 --checkers=32 -v --config "D:\PortableSystem\rclone.conf" --ignore-errors --no-update-modtime
          C:\ProgramData\chocolatey\bin\rclone.exe copy "splitter:Backup/Program Files" "C:\Program Files" --transfers=16 --checkers=32 -v --config "D:\PortableSystem\rclone.conf" --ignore-errors --no-update-modtime
          C:\ProgramData\chocolatey\bin\rclone.exe copy "splitter:Backup/Program Files (x86)" "C:\Program Files (x86)" --transfers=16 --checkers=32 -v --config "D:\PortableSystem\rclone.conf" --ignore-errors --no-update-modtime
          
          echo.
          echo [Restore] Registry Keys...
          if exist "D:\PortableSystem\Registry\HKCU.reg" (
              echo Importing User Settings...
              reg import "D:\PortableSystem\Registry\HKCU.reg" >nul 2>&1
          )
          if exist "D:\PortableSystem\Registry\HKLM_Software.reg" (
              echo Importing Program Keys (Errors Expected on Locked Keys)...
              reg import "D:\PortableSystem\Registry\HKLM_Software.reg" >nul 2>&1
          )

          echo.
          echo [Restore] Chrome User Data...
          taskkill /F /IM chrome.exe /T >nul 2>&1
          C:\ProgramData\chocolatey\bin\rclone.exe copy splitter:Backup/ChromeData "%LOCALAPPDATA%\Google\Chrome\User Data" --transfers=16 --checkers=32 -v --config "D:\PortableSystem\rclone.conf" --ignore-errors --no-update-modtime

          echo âœ… Restore Complete!
          pause
          "@
          Set-Content -Path "$portableRoot\Desktop\Download-From-Cloud.bat" -Value $downloadScript

          # Create 'Repair MegaHub' batch file (Panic Button)
          $repairScript = @"
          @echo off
          echo Repairing MegaHub Configuration...
          taskkill /F /IM rclone.exe /T >nul 2>&1
          timeout /t 2 /nobreak >nul
          
          REM Force delete old config to prevent "Rename Access Denied" errors
          if exist "D:\PortableSystem\rclone.conf" del /F /Q "D:\PortableSystem\rclone.conf"
          
          C:\ProgramData\chocolatey\bin\rclone.exe config create mega1 mega user itmemugpig@otona.uk pass itmemugpig@otona.uk --non-interactive --config "D:\PortableSystem\rclone.conf"
          C:\ProgramData\chocolatey\bin\rclone.exe config create mega2 mega user b67ebe3c01@webxio.pro pass b67ebe3c01@webxio.pro --non-interactive --config "D:\PortableSystem\rclone.conf"
          C:\ProgramData\chocolatey\bin\rclone.exe config create mega3 mega user d4d8692a49@webxio.pro pass d4d8692a49@webxio.pro --non-interactive --config "D:\PortableSystem\rclone.conf"
          timeout /t 1 /nobreak >nul
          C:\ProgramData\chocolatey\bin\rclone.exe config create pool union upstreams "mega1:FullSystem mega2:FullSystem mega3:FullSystem" action_policy epall create_policy lfs search_policy ff --non-interactive --config "D:\PortableSystem\rclone.conf"
          timeout /t 1 /nobreak >nul
          C:\ProgramData\chocolatey\bin\rclone.exe config create splitter chunker remote pool: chunk_size 256M hash_type md5 --non-interactive --config "D:\PortableSystem\rclone.conf"
          echo Done! Try Upload/Download now.
          pause
          "@
          Set-Content -Path "$portableRoot\Desktop\Repair-MegaHub.bat" -Value $repairScript

          # 3. Create Login Script (Run for User on Login) -> MOVED TO PRE-LOAD STEP
          # The redirection is now handled *before* login for speed and reliability.
          
          # Force clean exit to prevent 'First Run' error code from failing the step
          exit 0





      - name: Establish Tailscale Connection (Interactive Link)
        run: |
          Write-Host "Starting Tailscale..."
          Write-Host "ðŸ‘‰ PLEASE CHECK THE LOGS BELOW FOR THE AUTHENTICATION LINK ðŸ‘ˆ"
          Write-Host "Copy the link and paste it in your browser to approve the device."
          Write-Host "Copy the link and paste it in your browser to approve the device."
          
          # "Log Siphon" Method: Redirect to file, then read file to console.
          # This creates a hard bypass for any buffer suppression.
          # "Log Siphon" Method: Redirect to SEPARATE files (PowerShell constraint).
          $logOut = "ts_out.log"
          $logErr = "ts_err.log"
          $argList = "up --hostname=gh-runner-$env:GITHUB_RUN_ID"
          $p = Start-Process -FilePath "$env:ProgramFiles\Tailscale\tailscale.exe" -ArgumentList $argList -RedirectStandardOutput $logOut -RedirectStandardError $logErr -PassThru
          
          $lastLenOut = 0
          $lastLenErr = 0
          
          while (-not $p.HasExited) {
              # Check Stdout
              if (Test-Path $logOut) {
                  $lines = @(Get-Content $logOut)
                  if ($lines.Count -gt $lastLenOut) {
                      for ($k = $lastLenOut; $k -lt $lines.Count; $k++) { Write-Host "[OUT] $($lines[$k])" }
                      $lastLenOut = $lines.Count
                  }
              }
              # Check Stderr (Link is usually here)
              if (Test-Path $logErr) {
                  $lines = @(Get-Content $logErr)
                  if ($lines.Count -gt $lastLenErr) {
                      for ($k = $lastLenErr; $k -lt $lines.Count; $k++) { Write-Host "[ERR] $($lines[$k])" }
                      $lastLenErr = $lines.Count
                  }
              }
              Start-Sleep -Seconds 3
          }
          
          $tsIP = $null
          $retries = 0

          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Verify RDP Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Maintain Connection
        run: |
          $ownershipNotice = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("Cj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogQ29weXJpZ2h0IMKpIDIwMjUgVG9vbGJveExhcC54eXogfCBodHRwczovL3d3dy50b29sYm94bGFwLnh5ei8KIEFsbCByaWdodHMgcmVzZXJ2ZWQuIERvIG5vdCByZW1vdmUgb3IgbW9kaWZ5IGNvcHlyaWdodCB0ZXh0LgogWW91VHViZTogaHR0cHM6Ly93d3cueW91dHViZS5jb20vY2hhbm5lbC9VQ0RUNGZzOUp3cm5RSVhQclhYOHlIZVEKIEZhY2Vib29rOiBodHRwczovL3d3dy5mYWNlYm9vay5jb20vcHJvZmlsZS5waHA/aWQ9NjE1Njc4OTY2OTI5OTQKIEFueSBjaGFuZ2VzIHdpbGwgYXV0b21hdGljYWxseSBkaXNhYmxlIHRoaXMgc2NyaXB0IQo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0K"))
          Write-Host $ownershipNotice
          Write-Host "`n=== RDP ACCESS ==="
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: TOOLBOXLAP"
          Write-Host "Password: admin@123"
          Write-Host "Powered by https://www.toolboxlap.xyz/"
          Write-Host "========= All rights reserved =========`n"
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
              Start-Sleep -Seconds 300
          }